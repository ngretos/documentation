# Γενικά
Η παραμετροποίηση μιας φόρμας (tab) γίνεται με την περιγραφή σε json format των ιδιοτήτων της φόρμας αλλά και των επιμέρους πεδίων της (columns). Κάθε φόρμα είναι ένας διδιάστατος πίνακας κάθε γραμμή (row) του οποίου αποτελείται από της στήλες που περιγράφονται στο πεδίο columns του αντίστοιχου json. Κάθε στήλη μπορεί να μην εμφανίζεται καθόλου, να εμφανίζεται μόνο στην λεπτομερή φόρμα που ανοίγει με το πάτημα του κουμπιού, ή να εμφανίζεται και στο συνοπτικό πινακάκι στην αρχική οθόνη.
# Αποθήκευση δεδομένων
Τα δεδομένα κάθε φόρμας αποθηκεύονται στον πίνακα ContractModificationHistory στην στήλη CmhWorkingData και ακολουθούν το xsd schema που δηλώνεται στα jsondata. Επομένως τα ονόματα των στηλών (όπως δηλώνονται στα jsondata) πρέπει να συμφωνούν με τα ονόματα που είναι δηλωμένα στο xsd. Το ίδιο ισχύει και για τον τύπο των δεδομένων (πχ δεν μπορεί να αποθηκευτεί κείμενο σε integer πεδίο)
# Δήλωση jsondata
Ποιον πίνακα jsondata θα χρησιμοποιήσει η κάθε φόρμα, δηλώνεται στο αντίστοιχο πεδίο του wizard. Εκεί δηλώνεται το όνομα του πίνακα και προαιρετικά το όνομα του qualifier. Κατά το σχηματισμό της φόρμας διαβάζονται οι εγγραφς του πίνακα jsondata και σχηματίζεται η περιγραφή της φόρμας (Την περιγραφή θα την αποκαλούμαι metadata).
Η δημιουργία των metadata γίνεται με τον εξής τρόπο:
1. Διαβάζονται από τον πίνακα jsondata 4 καταχωρήσεις

| TableName | Qualifier | CallID | CallPhaseID |
| --------- | --------- |------- |------------ |
| from Wizard | null | null | null |
| from Wizard | from Wizard | null | null |
| from Wizard | from Wizard | CallId | null |
| from Wizard | from Wizard | CallId | CallPhaseId |

2. Δημιουργούνται τα τελικά metadata κάνοντας συγχώνευση(merge) όλων των πεδίων. Αν ένα πεδίο εμφανίζεται σε παραπάνω από 1 καταχωρήσεις προτεραιότητα έχει αυτό που βρίσκεται σε πιο κάτω γραμμή σύμφωνα με τον παραπάνω πίνακα.
# Δήλωση Calldata
Έχει αναπτυχθεί η ενοποιημένη υλοποίηση στο πλαίσιο της οποίας υπάρχει ακόμα μία καταχώρηση json με ακόμα μεγαλύτερη προτεραιότητα. 
Αν η συγκεκριμένη δράση εντάσσεται στο πλαίσιο της ενοποιημένης υλοποίησης υπάρχει μια καταχώρηση στον πίνακα invitation που περιέχει μια καταχώρηση για κάθε φόρμα.

Γίνεται αναζήτηση στο json αντικείμενο των Calldata για την ενότητα με όνομα αυτό που αναφρεται στα metadata. Αν βρεθεί τέτοια ενότητα συγχωνεύεται το περιεχόμενό της με τα metadata και δημιουργούνται τα τελικά metadata που περιγράφουν τη φόρμα
# Τεκμηρίωση metadata

| Πεδίο | Τύπος | Σημασία | Παρατηρήσεις |
| --------- | --------- |------- |------------ |
| name | | Σε ποιον πίνακα του xml θα γραφτεί η πληροφορία |  |
| single| text | Αν "1" επιτρέπεται μόνο μία εγγραφή| |
| hidden| text | Αν "1" απενεργοποιείται όλη η φόρμα| Μόνο CallData|
| hiddenColumns | array[text] ή "*" | Πίνακας με τα ονόματα των στηλών που δεν θα εμφανιστούν. Αν "*" κρύβονται όλες οι στήλες| Μόνο CallData| 
| showColumns| array[text] | Πίνακας με τα ονόματα των στηλών που θα εμφανιστούν. Έχει προτεραιότητα έναντι του hiddenColumns| Χρησιμοποιείται σε συνδυασμό με το hiddenColumns "*" - Μόνο CallData| 
| datafilter| text | sql predicate βάσει του οποίου φιλτράρονται οι γραμμές που θα επιστρέφονται | |
| readonly| text| Αν "1" δεν επιτρέπεται η επεξεργασία | |
| title| text | Ο τίτλος της φόρμας | |
| allowundelete| |  | |
| detail| text| Αν "1" η φόρμα ανοίγει με λεπτομερή εμφάνιση των δεδομένων | |
| display| |  | |
| minRows| number| Στον έλεγχο ορθότητας ελέγχεται αν υπάρχουν τουλάχιστον τόσες καταχωρήσεις| Μόνο στα CallData. Μόνο για callid 204|
| maxRows| number| Στον έλεγχο ορθότητας ελέγχεται αν υπάρχουν το πολύ τόσες καταχωρήσεις| Μόνο στα CallData. Μόνο για callid 204|
| minForeignRows| number| Στον έλεγχο ορθότητας ελέγχεται αν υπάρχουν τουλάχιστον τόσες καταχωρήσεις αν φορέα| Μόνο στα CallData. Μόνο για callid 204|
| maxForeignRows| number| Στον έλεγχο ορθότητας ελέγχεται αν υπάρχουν το πολύ τόσες καταχωρήσεις αν φορέα| Μόνο στα CallData. Μόνο για callid 204|
| columns| array[column] | μία καταχώρηση για κάθε πεδίο που εμφανίζεται στη φόρμα | |
| customise| string | Αρχικά καθόριζε μια javascript function η οποία περιείχε κώδικα ειδικό για την συγκεκριμένη περίπτωση (δράση, ενέργεια, qualifier, κτλ). Με την εισαγωγή της απλοποιημένης εκδοχής του συστήματος λόγω του ότι η δήλωση αυτή χρησιμοποιήται για να δηλώσει το τμήμα των calldata με βάση τα οποία θα τροποποιηθούν τα matadata αλλά και για λόγους τεκμηρίωσης του κώδικα και παρ' ότι η συγκεκριμένη δήλωση συνεχίζει να λειτουργεί για τις πριν της απλοποιημένης εκδοχής του συστήματος εφαρμογές της, συνίσταται, η χρήση της δήλωσης "javascript" αντί του "customise".| |
| javascript| string | Καθορίζει μια javascript function η οποία περιέχει κώδικα ειδικό για την συγκεκριμένη περίπτωση (δράση, ενέργεια, qualifier, κτλ). (βλ. και "customise")| |
| doNotAllowDelete| string | Αποτρέπει την εμφάνιση του κουμπιού "Delete" στις λίστες.| |

## Περιγραφή column
| Πεδίο | Τύπος | Σημασία | Παρατηρήσεις |
| --------- | --------- |------- |------------ |
| name | text | To xml πεδίο που θα καταχωρηθε η πληροφορία |  |
| label| text | Το κείμενο που εμφανίζεται δίπλα στο πεδίο| |
| vord| number | Καθορίζει τη σειρά εμφάνισης στη φόρμα| Το μικρότερο πάει πάνω|
| edit| text | Αν "" το πεδίο δεν εμφανίζεται στη φόρμα| Βλέπε σχόλια view |
| view| text | Αν "" το πεδίο δεν εμφανίζεται στo συνοπτικό πινακάκι| Αν edit και view είναι "" τότε το πεδίο δεν εμφανίζεται πουθενά και τα δεδομένα που ενδεχομένως περιέχει δεν έρχονται στον browser. Πεδία που είναι κρυμμένα στα jsondata δεν γίνεται να εμφανιστούν από τα CallData|
| hidden| text | Αν "1" το πεδίο δεν εμφανίζεται, τα δεδομένα που περιέχει μεταφέρονται στον browser| Αν θέλουμε να μην χρησιμοποιήσουμε καθόλου ένα πεδίο χρησιμοποιούμε το edit view ""|
| required| text | Αν "1" το πεδίο είναι απαραίτητο και η φόρμα δεν υποβάλλεται αν είναι κενο | |
| etype| text | Περιγράφει τον τύπο του πεδίου, ακολουθει πίνακας με τις δυνατές τιμς και τη σημασία τους| |
| items| array[{lab, val}] | Πίνακας με τις δυνατές επιλογές | Μόνο για etype = select |
| lookup | text | Από που αντλούνται οι τιμές του select - Ακολουθεί επεξηγηματικός πίνακας| Μόνο για etype = select |
| disopt | text | | |
| labcol | text | | |
| valcol | text | | |
| sort | text | | |
| lkptable | text | | |
| colw| text | | |
| labw| text | | |
| data-limit| text | Αν "1" θα εφαρμοστούν οι έλεγχοι για data-min και data-max εφόσον υπάρχουν| |
| data-min| any | Ορίζεται η ελάχιστη επιτρεπτή τιμή| |
| data-max| any | Ορίζεται η μέγιστη επιτρεπτή τιμή| |
| data-hide-when| text | Boolean expression που αν είναι αληθής το πεδίο κρύβεται. Η αποτίμηση γίνεται κάθε φορά που αλλάζει ένα πεδίο της φόρμας. Αν το πεδίο είναι required τότε σε περίπτωση που κρυφτεί παύει να είναι required. Σε περίπτωση που εμφανιστεί ξανά ειναι και πάλι required. Η boolean expression μπορει να περιέχει και ονόματα μεταβλητών μέσα σε {{ }}. Π.χ `"data-hide-when" : "{{CNT_ActivitiesDescription}} <= 200"` | |
| extra-tags| object | Tα attributes που θα μεταφερθούν στο html element| |

## extra-tags
| Όνομα | Περιεχόμενο |
| --------- | --------- |
| data-require-when | Boolean expression που αν είναι αληθής το πεδίο ειναι υποχρεωτικό. Λειτουργεί όπως και το data-hide-when. |
| data-limit | το ίδιο με παραπάνω |
| data-min | το ίδιο με παραπάνω |
| data-max | το ίδιο με παραπάνω |
| data-grid_compare | (αν έχει χρησιμοποιηθεί grid με checkboxes) Ελέγχει αν υπάρχουν checked (στη στήλη grid_filter) rows στο grid με error message αυτό που θα καθοριστεί στο grid_errmsg2 . Επίσης ελέγχει αν το άθροισμα τιμών της στήλης (grid_column) είναι μεγαλύτερο από το πεδίο με αυτό το attribute μετρώντας μόνο όσες γραμμές είναι checked, με error message αυτό που θα καθοριστεί στο grid_errmsg1. |
| data-greater_than | Ελέγχει αν το πεδίο είναι μεγαλύτερο από αυτό που θα του δώσουμε.|

Στα πεδία data-hide-when και data-require-when βάζουμε μια boolean expression που θα αποτιμηθεί και θα επιστρέψει. Μπορούμε να βάλουμε και ονόματα στηλών μέσα σε {{ }} και αυτά θα αντικατασταθούν με την τιμή της στήλης. Αν θέλουμε η στήλη μας να συγκριθεί ως string τότε πρέπει να τη βάλουμε σε εισαγωγικά:
```json
"data-require-when": "'{{Comments1}}' == 'μπλα μπλα'"
```
Παράδειγμα χρήσης του data-require-when: 
```json
{
    "name": "P_LegalName",
    "extra-tags": {
        "data-require-when": "{{CNT_ActivitiesDescription}} <= 200"
    }
}
```
